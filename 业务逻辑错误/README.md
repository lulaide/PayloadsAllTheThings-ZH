# 业务逻辑错误

> 业务逻辑错误，也称为业务逻辑漏洞，是一种应用程序漏洞，源于应用程序的业务逻辑，这部分程序处理现实世界的业务规则和流程。这些规则可能包括定价模型、交易限制或在多步骤过程中需要遵循的操作序列。

## 概述

* [方法论](#方法论)
    * [审查功能测试](#审查功能测试)
    * [折扣码功能测试](#折扣码功能测试)
    * [配送费用操纵](#配送费用操纵)
    * [货币套利](#货币套利)
    * [高级功能利用](#高级功能利用)
    * [退款功能利用](#退款功能利用)
    * [购物车/愿望清单利用](#购物车/愿望清单利用)
    * [线程评论测试](#线程评论测试)
* [参考文献](#参考文献)

## 方法论

与SQL注入或跨站脚本（XSS）等其他类型的漏洞不同，业务逻辑错误并不依赖于代码本身的问题（如未过滤的用户输入）。相反，它们利用了应用程序正常、预期的功能，但以开发人员未曾预料的方式使用，从而导致不希望的结果。

常见业务逻辑错误示例。

### 审查功能测试

* 评估是否可以作为已验证的评论者发布产品评论而无需购买该商品。
* 尝试提供超出标准范围的评分，例如在1到5的评分系统中使用0、6或负数。
* 测试同一用户是否可以为单一产品多次发布评分。这有助于检测潜在的竞态条件。
* 确定文件上传字段是否允许所有扩展名；开发人员常常忽视对这些端点的保护。
* 调查是否可以通过冒充其他用户来发布评论。
* 尝试针对此功能进行跨站请求伪造（CSRF），因为它通常没有令牌保护。

### 折扣码功能测试

* 尝试多次应用相同的折扣码，以评估其是否可重复使用。
* 如果折扣码是唯一的，通过同时为两个账户应用相同的折扣码来评估是否存在竞态条件。
* 测试是否存在质量分配或HTTP参数污染漏洞，以查看是否可以在应用程序设计为仅接受一个折扣码时应用多个折扣码。
* 测试因缺少输入清理（如XSS、SQL注入）在此功能上是否存在漏洞。
* 尝试通过操作服务器端请求来将折扣码应用于非折扣商品。

### 配送费用操纵

* 实验性地使用负值的配送费用，看看是否能减少最终金额。
* 评估是否可以通过修改参数激活免费配送。

### 货币套利

* 尝试用一种货币（例如USD）支付，然后以另一种货币（例如EUR）要求退款。汇率差异可能导致利润。

### 高级功能利用

* 探索是否可以访问高级账户专用的部分或端点而无需有效的订阅。
* 购买高级功能，取消它，并查看在退款后是否仍可以使用。
* 查看请求/响应中的真/假值以验证高级访问权限。使用Burp的匹配和替换工具来更改这些值以实现未经授权的高级访问。
* 查看cookie或本地存储中的变量以验证高级访问权限。

### 退款功能利用

* 购买产品，申请退款，并查看产品是否仍然可以访问。
* 寻找货币套利的机会。
* 提交多个取消订阅的请求，检查多重退款的可能性。

### 购物车/愿望清单利用

* 测试系统，添加负数量的产品以及其它产品，以平衡总金额。
* 尝试添加比现有库存更多的产品。
* 检查愿望清单或购物车中的产品是否可以移动到另一个用户的购物车或从中删除。

### 线程评论测试

* 检查线程中评论数量是否有上限。
* 如果用户只能评论一次，使用竞态条件查看是否可以发表多次评论。
* 如果系统允许经过验证或特权用户的评论，请尝试模仿这些参数并查看是否可以发表评论。
* 尝试冒充其他用户发表评论。

## 参考文献

* [业务逻辑漏洞 - PortSwigger - 2024](https://portswigger.net/web-security/logic-flaws)
* [业务逻辑漏洞 - OWASP - 2024](https://owasp.org/www-community/vulnerabilities/Business_logic_vulnerability)
* [CWE-840: 业务逻辑错误 - CWE - 2011年3月24日](https://cwe.mitre.org/data/definitions/840.html)
* [业务逻辑漏洞示例 - PortSwigger - 2024](https://portswigger.net/web-security/logic-flaws/examples)